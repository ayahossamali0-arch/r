<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Ù…Ù‡Ù… -->
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap');

:root{
  --header-h: 72px; /* Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù‡ÙŠØ¯Ø± */
  --accent1: #00aaff;
  --accent2: #8a2be2;
  --accent3: #ff69b4;
  --radius: 12px;
  --gap: 12px;
}

*{box-sizing:border-box}
body {
  margin: 0;
  font-family: 'Cairo', sans-serif;
  background: #f5f5f5;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  color:#222;
  padding-top: calc(var(--header-h) + 12px); /* ÙŠØ¶Ù…Ù† Ø¹Ø¯Ù… Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø®Ù„Ù Ø§Ù„Ù‡ÙŠØ¯Ø± */
}

/* Header Ø«Ø§Ø¨Øª */
.header {
  height: var(--header-h);
  background: linear-gradient(45deg,var(--accent1),var(--accent2),var(--accent3));
  color: white;
  padding: 10px 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 700;
  box-shadow: 0 4px 6px rgba(0,0,0,0.12);
  position: fixed;
  top: 0;
  right: 0;
  left: 0;
  z-index: 1000;
}

/* Ù†Ø³ØªØ®Ø¯Ù… Ø­Ø§ÙˆÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‡ÙŠØ¯Ø± Ù…Ø±Ù†Ø© Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙÙŠ Ø§Ù„ÙŠÙ…ÙŠÙ† */
.header .inner {
  width: 90%;
  max-width: 1100px;
  margin: 0 auto;
  display:flex;
  align-items:center;
  justify-content: center;
  position:relative;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù‡ÙŠØ¯Ø±: Ù†Ø¶Ø¹Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† (RTL) */
.header .icon {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  height: 44px;
  width: 44px;
  border-radius: 50%;
  object-fit: cover;
  box-shadow: 0 0 8px rgba(255,255,255,0.6);
  background: rgba(255,255,255,0.06);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition: transform .18s, box-shadow .18s;
}

/* ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª â€” right Ù„Ø£Ù†Ù‡ RTL */
#logoutBtn { right: -50px; }
#deleteBtn { right: 0px; }
#ragBtn    { right: 55px; }

/* ØªØ£Ø«ÙŠØ± hover / active */
.header .icon:hover { transform: translateY(-50%) scale(1.06); box-shadow: 0 6px 18px rgba(0,0,0,0.16); }

/* Ù†Øµ RAG Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙŠØ¯Ø± */
#ragText {
  position: absolute;
  right: 111px;
  top: 50%;
  transform: translateY(-50%);
  font-weight: 700;
  color: white;
  font-size: 14px;
}

/* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
.container {
  width: 94%;
  max-width: 950px;
  margin: 0 auto 40px auto;
  background: #fff;
  padding: 24px;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.06);
}

/* add panel */
.add-panel {
  display:flex;
  gap:10px;
  margin-bottom:14px;
  flex-wrap:wrap;
  align-items:center;
}

.add-panel input[type=text] {
  flex:1;
  padding:10px 12px;
  border:2px solid #e0e0e0;
  border-radius:10px;
  outline:none;
  font-size:14px;
  background:#fff;
}

.custom-file-label {
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border:2px solid transparent;
  border-radius:20px;
  background: linear-gradient(45deg,var(--accent1),var(--accent2),var(--accent3));
  color:#fff;
  font-weight:700;
  font-size:13px;
  cursor:pointer;
}

/* Ø²Ø± Ø¥Ø¶Ø§ÙØ© */
.add-panel button {
  padding:10px 16px;
  border:none;
  border-radius:22px;
  background: linear-gradient(45deg,var(--accent1),var(--accent2),var(--accent3));
  color:#fff;
  font-weight:700;
  cursor:pointer;
  transition: transform .15s;
}
.add-panel button:active{ transform: scale(.98); }

/* search panel */
.search-panel {
  display:flex;
  gap:10px;
  margin:8px 0 10px 0;
  align-items:center;
  flex-wrap:wrap;
}
.search-panel input[type=text],
.search-panel select {
  padding:10px;
  border:2px solid #e0e0e0;
  border-radius:10px;
  outline:none;
  background:#fff;
  font-size:14px;
}
.search-panel input[type=text]{ flex:2; min-width:140px; }
.search-panel select{ flex:0.8; min-width:120px; }

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¨Ø­Ø« ÙƒØ²Ø± */
.search-panel img { width:38px; height:38px; cursor:pointer; transition:transform .12s; }
.search-panel img:hover{ transform: scale(1.06); }

/* Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ù‚Ø§Ø¨Ù„ÙŠØ© ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ */
.table-wrapper { width:100%; overflow-x:auto; border-radius:10px; background:transparent; padding-bottom:6px; }
table { width:100%; border-collapse:collapse; min-width:620px; direction:rtl; }
table, th, td { border: 1px solid #e6e6e6; }
th, td { padding:12px; text-align:right; vertical-align:top; font-size:14px; background:#fff; }
th {
  background: linear-gradient(45deg,var(--accent1),var(--accent2),var(--accent3));
  color:#fff;
  font-weight:700;
}

/* editable cell */
td.editable { cursor:text; }
td.editable:hover { background-color:#f7fbff; }

/* selected row style */
tr.selected-row { background-color:#e6f3ff; }

/* preview */
.file-preview img { max-width:150px; border-radius:8px; display:block; }
.file-preview a { color:#007bff; text-decoration:none; }
.file-preview a:hover{ text-decoration:underline; }

/* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø­ÙØ¸ Ø¨Ø³ÙŠØ·Ø© */
.ss-icon { height:26px; width:26px; vertical-align:middle; margin-left:6px; cursor:pointer; }

/* responsive tweaks */
@media (max-width:760px){
  :root{ --header-h: 64px; }
  .header { font-size:16px; }
  #ragText { display:none; } /* Ù†Ø®ØªØµØ± ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ */
  .header .icon{ height:40px; width:40px; }
  .container { padding:16px; }
  th, td { padding:10px; font-size:13px; }
  .file-preview img { max-width:120px; }
  table { min-width:560px; } /* ÙŠÙ‚Ù„Ù„ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
}

@media (min-width:1200px){
  body { padding-top: calc(var(--header-h) + 18px); }
}
</style>
</head>
<body>

<div class="header" role="banner">
  <div class="inner">
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† (RTL) -->
    <img id="logoutBtn" class="icon" src="{{ url_for('static', filename='adminicon.png') }}" alt="Ø®Ø±ÙˆØ¬" onclick="logoutAdmin()" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
    <img id="deleteBtn" class="icon" src="{{ url_for('static', filename='nn.png') }}" alt="Ø­Ø°Ù" onclick="deleteSelected()" title="Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯">
    <img id="ragBtn" class="icon" src="{{ url_for('static', filename='artificial-intelligence.png') }}" alt="Ù†Ø¸Ø§Ù… RAG" title="Ù†Ø¸Ø§Ù… RAG">
    <span id="ragText">Ù†Ø¸Ø§Ù… RAG</span>

    <!-- Ø¹Ù†ÙˆØ§Ù† Ù…Ø±ÙƒØ²ÙŠ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <div style="text-align:center; font-size:1rem;">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
  </div>
</div>

<div class="container" role="main">
  <form id="addForm" class="add-panel" enctype="multipart/form-data">
    <input type="text" name="content" id="addContent" placeholder="Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ØªØ®Ø²ÙŠÙ†Ø©" autocomplete="off">

    <label for="addFile" class="custom-file-label" aria-hidden="false">
      <span id="fileLabelText">Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§</span>
      <!-- ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù‡Ù†Ø§ -->
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 16 16" fill="#fff">
        <path d="M.5 9.9a.5.5 0 0 1 .5.5v3.1h14V10.4a.5.5 0 0 1 1 0v3.1a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V10.4a.5.5 0 0 1 .5-.5z"/>
        <path d="M7.646 1.146a.5.5 0 0 1 .708 0L11 3.793V10.5a.5.5 0 0 1-1 0V4.707L8 2.707 4 6.707V10.5a.5.5 0 0 1-1 0V3.793l3.646-2.647z"/>
      </svg>
    </label>
    <input type="file" name="file" id="addFile" hidden>
    <button type="submit" aria-label="Ø¥Ø¶Ø§ÙØ©">Ø¥Ø¶Ø§ÙØ©</button>
  </form>

  <div class="search-panel">
    <input type="text" id="searchQuery" placeholder="Ø¨Ø­Ø«..." oninput="searchOnInput()" autocomplete="off">
    <select id="searchType" aria-label="Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø­Ø«">
      <option value="id">Ø¨Ø­Ø« Ø¹Ù† Ø·Ø±ÙŠÙ‚ ID</option>
      <option value="text">Ø¨Ø­Ø« Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù†Øµ</option>
    </select>
    <img src="{{ url_for('static', filename='check.png') }}" alt="Ø¨Ø­Ø«" title="Ø§Ø¨Ø­Ø«" onclick="performSearch()">
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Ø§Ù„Ù…Ø­ØªÙˆÙ‰</th>
          <th>ØªØ¹Ø¯ÙŠÙ„</th>
        </tr>
      </thead>
      <tbody id="resultsBody">
        {% for item in data %}
        <tr data-id="{{ item.id }}">
          <td>{{ item.id }}</td>

          <td class="editable" contenteditable="false">
            <span class="edit-text" contenteditable="true">{% if item.content %}{{ item.content|safe }}{% endif %}</span>

            {% if item.file_url %}
            <div class="file-preview">
              {% if item.file_url.endswith('.jpg') or item.file_url.endswith('.png') or item.file_url.endswith('.jpeg') %}
                <img src="{{ item.file_url }}" alt="file">
              {% else %}
                <a href="{{ item.file_url }}" target="_blank" rel="noopener">ğŸ“ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</a>
              {% endif %}
            </div>
            {% endif %}
          </td>

          <td class="modified-cell"></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
/* ÙˆØ¸Ø§Ø¦Ù JS - Ø§Ø­ØªÙØ¸Øª Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØŒ Ù…Ø¹ Ø¨Ø¹Ø¶ Ø§Ù„ØªØµØ­ÙŠØ­Ø§Øª */
function logoutAdmin() { window.location.href = "{{ url_for('logout') }}"; }

document.getElementById('ragBtn').addEventListener('click', function() {
    window.location.href = "{{ url_for('index_public') }}";
});

const fileInput = document.getElementById('addFile');
const fileLabelText = document.getElementById('fileLabelText');
fileInput.addEventListener('change', () => {
  fileLabelText.textContent = fileInput.files.length > 0 ? fileInput.files[0].name : 'Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§';
});

/* attachEditable: ÙŠÙ†Ø´Ø¦ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø­ÙØ¸ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
function attachEditable(td) {
  const row = td.parentElement;
  const span = td.querySelector(".edit-text");
  const modifiedCell = row.querySelector('.modified-cell');

  let original = span.textContent.trim();

  span.addEventListener('input', () => {
    let existingCheck = modifiedCell.querySelector('img');

    if (span.textContent.trim() !== original) {

      if (!existingCheck) {
        const check = document.createElement('img');
        check.src = "{{ url_for('static', filename='ss.png') }}";
        check.className = 'ss-icon';
        check.title = 'Ø§Ø¶ØºØ· Ù„Ù„Ø­ÙØ¸';

        check.addEventListener('click', async () => {
          const id = row.dataset.id;
          const newContent = span.textContent.trim();

          const form = new FormData();
          form.append('id', id);
          form.append('content', newContent);

          try {
            const res = await fetch("{{ url_for('update_item') }}", { method: 'POST', body: form });
            const data = await res.json();

            if (data.success) {
              original = newContent;
              span.textContent = newContent;
              check.remove();
            } else {
              alert("ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
            }

          } catch (err) {
            console.error(err);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«");
          }
        });

        modifiedCell.appendChild(check);
      }
    } 
    else if (existingCheck) existingCheck.remove();
  });
}

let selectedRow = null;
function attachRowEvents(row) {
  row.addEventListener('mouseenter', () => { if (row !== selectedRow) row.style.backgroundColor = '#f7fbff'; });
  row.addEventListener('mouseleave', () => { if (row !== selectedRow) row.style.backgroundColor = ''; });
  row.addEventListener('click', () => {
    if (selectedRow) selectedRow.classList.remove('selected-row');
    selectedRow = row;
    selectedRow.classList.add('selected-row');
  });
}

/* ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© */
document.querySelectorAll('td.editable').forEach(td => attachEditable(td));
document.querySelectorAll('#resultsBody tr').forEach(row => attachRowEvents(row));

/* Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø¹Ø±Ø¶ÙŠ (Ø¥Ø°Ø§ Ø§Ø­ØªØ¬Øª Ù„Ø°Ù„Ùƒ Ù…Ø­Ù„ÙŠÙ‹Ø§) */
function resequenceIDs() {
    const rows = document.querySelectorAll('#resultsBody tr');
    rows.forEach((row, index) => {
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ù† ÙƒÙ†Øª ØªØ±ÙŠØ¯ Ø£Ù† ØªØ¨Ù‚Ù‰ ID Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙÙ„Ø§ ØªØ¹ÙŠØ¯ ÙƒØªØ§Ø¨ØªÙ‡ Ù‡Ù†Ø§
        row.querySelector('td:first-child').textContent = index + 1;
    });
}

/* Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯ */
const addForm = document.getElementById('addForm');
addForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  const content = document.getElementById('addContent').value.trim();
  if (!content && !fileInput.files.length) return alert("Ø£Ø¶Ù Ù†ØµÙ‹Ø§ Ø£Ùˆ Ù…Ù„ÙÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„");

  const formData = new FormData();
  formData.append('content', content);
  if (fileInput.files[0]) formData.append('file', fileInput.files[0]);

  try {
    const res = await fetch("{{ url_for('add_item') }}", { method: 'POST', body: formData });
    const data = await res.json();

    if (data.success) {
      const tbody = document.getElementById('resultsBody');
      const newItem = data.new_item;

      let fileHTML = "";
      if (newItem.file_url) {
        if (newItem.file_url.endsWith('.jpg') || newItem.file_url.endsWith('.png') || newItem.file_url.endsWith('.jpeg')) {
          fileHTML = `<div class="file-preview"><img src="${newItem.file_url}" alt="file"></div>`;
        } else {
          fileHTML = `<div class="file-preview"><a href="${newItem.file_url}" target="_blank" rel="noopener">ğŸ“ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</a></div>`;
        }
      }

      const tr = document.createElement('tr');
      tr.dataset.id = newItem.id;

      tr.innerHTML = `
        <td>${newItem.id}</td>
        <td class="editable" contenteditable="false">
            <span class="edit-text" contenteditable="true">${content}</span>
            ${fileHTML}
        </td>
        <td class="modified-cell"></td>
      `;

      tbody.appendChild(tr);
      attachEditable(tr.querySelector('.editable'));
      attachRowEvents(tr);

      document.getElementById('addContent').value = '';
      fileInput.value = '';
      fileLabelText.textContent = 'Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§';

      // resequenceIDs(); // Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ø´ØºÙ‘Ù„Ù‡ Ù„Ùˆ ØªØ±ÙŠØ¯ ØªØ±Ù‚ÙŠÙ… Ù…Ø­Ù„ÙŠ
    } else {
      alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    }
  } catch (err) {
    console.error(err);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  }
});

/* Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯ */
async function deleteSelected() {
    if (!selectedRow) return alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ØµÙ");
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;

    const item_id = selectedRow.dataset.id;

    try {
        const response = await fetch(`/delete/${item_id}`, {
            method: "POST"
        });

        const data = await response.json();

        if (data.success) {
            selectedRow.remove();
            selectedRow = null;
            // resequenceIDs(); // Ø§Ø®ØªÙŠØ§Ø±ÙŠ
        } else {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
        }

    } catch (error) {
        console.error(error);
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
    }
}

/* Ø§Ù„Ø¨Ø­Ø« */
async function performSearch() {
  const query = document.getElementById('searchQuery').value.trim();
  const type = document.getElementById('searchType').value;
  const tbody = document.getElementById('resultsBody');

  try {
    const res = await fetch("{{ url_for('search') }}?q=" + encodeURIComponent(query) + "&by=" + type);
    const data = await res.json();

    tbody.innerHTML = '';

    data.forEach((item) => {
      let fileHTML = "";
      if (item.file_url) {
        if (item.file_url.endsWith('.jpg') || item.file_url.endsWith('.png') || item.file_url.endsWith('.jpeg')) {
          fileHTML = `<div class="file-preview"><img src="${item.file_url}" alt="file"></div>`;
        } else {
          fileHTML = `<div class="file-preview"><a href="${item.file_url}" target="_blank" rel="noopener">ğŸ“ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</a></div>`;
        }
      }

      const tr = document.createElement('tr');
      tr.dataset.id = item.id;

      tr.innerHTML = `
        <td>${item.id}</td>
        <td class="editable" contenteditable="false">
            <span class="edit-text" contenteditable="true">${item.content || ''}</span>
            ${fileHTML}
        </td>
        <td class="modified-cell"></td>
      `;

      tbody.appendChild(tr);
      attachEditable(tr.querySelector('.editable'));
      attachRowEvents(tr);
    });
  } catch (err) {
    console.error(err);
    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«");
  }
}

function searchOnInput() {
  if (document.getElementById('searchQuery').value.trim() === '') performSearch();
}
</script>
</body>
</html>
